<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --text: #1a1a1a;
            --muted: #64748b;
            --accent: #2563eb;
            --accent-dark: #1e40af;
            --border: #e2e8f0;
            --shadow: rgba(15,23,42,0.08);
            --danger: #ef4444;
            --done: #94a3b8;
            --success: #22c55e;
            --warn: #f59e0b;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg); color: var(--text);
            min-height: 100vh;
            display: flex; align-items: flex-start; justify-content: center;
            padding: 3rem 1rem 5rem;
        }
        .container { width:100%; max-width:580px; animation: fadeUp .55s ease-out; }
        @keyframes fadeUp {
            from { opacity:0; transform:translateY(18px); }
            to   { opacity:1; transform:translateY(0); }
        }
        .card {
            background: var(--card); border-radius: 24px;
            box-shadow: 0 4px 6px -1px var(--shadow), 0 2px 4px -2px var(--shadow);
            padding: 2.75rem 2.5rem; transition: box-shadow .3s ease;
        }
        .card:hover { box-shadow: 0 20px 25px -5px var(--shadow), 0 8px 10px -6px var(--shadow); }

        /* Header */
        .header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:0.25rem; gap:1rem; }
        h1 { font-family:'Playfair Display',serif; font-size:2.4rem; font-weight:700; letter-spacing:-0.02em; line-height:1.1; }
        .live-clock {
            font-size:0.75rem; color:var(--muted);
            background:var(--bg); border:1px solid var(--border);
            border-radius:8px; padding:0.3rem 0.7rem;
            font-variant-numeric:tabular-nums; white-space:nowrap;
            margin-top:0.4rem; flex-shrink:0;
        }
        .subtitle { color:var(--muted); font-size:0.88rem; margin-bottom:0.4rem; }
        .task-counter { font-size:0.8rem; color:var(--accent); font-weight:600; margin-bottom:1.75rem; min-height:1.2em; }
        .task-counter span { color:var(--muted); font-weight:400; }

        /* Input area */
        .input-area { margin-bottom:1.75rem; }
        .input-row { display:flex; gap:0.6rem; margin-bottom:0.5rem; }
        #taskInput {
            flex:1; min-width:0; padding:0.8rem 1.1rem;
            border:2px solid var(--border); border-radius:12px;
            font-size:0.95rem; font-family:inherit;
            background:var(--bg); transition:all .2s;
        }
        #taskInput:focus { outline:none; border-color:var(--accent); background:#fff; box-shadow:0 0 0 3px rgba(37,99,235,.1); }
        #taskInput::placeholder { color:var(--muted); }
        #taskInput.flash-success { border-color:var(--success); box-shadow:0 0 0 3px rgba(34,197,94,.15); background:#f0fdf4; }
        #taskInput.editing { border-color:var(--warn); background:#fffbeb; box-shadow:0 0 0 3px rgba(245,158,11,.12); }

        .add-btn {
            padding:0.8rem 1.5rem; background:var(--accent); color:#fff;
            border:none; border-radius:12px; font-weight:600; font-size:0.95rem;
            font-family:inherit; cursor:pointer; transition:all .2s; white-space:nowrap;
        }
        .add-btn:hover { background:var(--accent-dark); transform:translateY(-1px); box-shadow:0 4px 12px rgba(37,99,235,.3); }
        .add-btn:active { transform:translateY(0); }
        .add-btn.pulse { animation:btnPulse .35s ease-out; }
        @keyframes btnPulse {
            0%   { transform:scale(1); }
            50%  { transform:scale(1.07); box-shadow:0 0 0 6px rgba(37,99,235,.15); }
            100% { transform:scale(1); }
        }
        .add-btn.editing-mode { background:var(--warn); }
        .add-btn.editing-mode:hover { background:#d97706; }

        /* Schedule toggle row */
        .schedule-toggle-row { display:flex; align-items:center; gap:0.75rem; }
        .schedule-toggle-btn {
            font-size:0.75rem; color:var(--muted); font-weight:500;
            background:none; border:1px dashed var(--border);
            border-radius:8px; padding:0.25rem 0.65rem;
            cursor:pointer; transition:all .18s; font-family:inherit;
        }
        .schedule-toggle-btn:hover { border-color:var(--accent); color:var(--accent); }
        .schedule-toggle-btn.active { border-color:var(--accent); color:var(--accent); background:#eff6ff; }

        /* Schedule row ‚Äî hidden by default */
        .schedule-row {
            display:none; align-items:center; gap:0.6rem;
            margin-top:0.5rem;
            animation: fadeIn .2s ease-out;
        }
        .schedule-row.visible { display:flex; }
        .schedule-label { font-size:0.78rem; color:var(--muted); font-weight:500; white-space:nowrap; }
        .time-input {
            padding:0.45rem 0.75rem; border:1.5px solid var(--border); border-radius:10px;
            font-size:0.85rem; font-family:inherit; background:var(--bg); color:var(--text); transition:all .2s;
        }
        .time-input:focus { outline:none; border-color:var(--accent); background:#fff; box-shadow:0 0 0 3px rgba(37,99,235,.1); }

        .edit-hint { font-size:0.75rem; color:var(--warn); font-weight:600; display:none; }
        .edit-hint.visible { display:inline; }
        .cancel-edit-btn {
            font-size:0.75rem; color:var(--muted); font-weight:500;
            background:none; border:none; cursor:pointer;
            text-decoration:underline; padding:0; display:none; font-family:inherit;
        }
        .cancel-edit-btn.visible { display:inline; }
        .cancel-edit-btn:hover { color:var(--text); }

        /* Toolbar */
        .toolbar {
            display:flex; align-items:center; justify-content:space-between;
            padding:0.625rem 0.875rem; background:var(--bg);
            border-radius:12px; border:1px solid var(--border);
            margin-bottom:1rem; gap:0.5rem;
        }
        .filter-group { display:flex; gap:0.25rem; }
        .filter-btn {
            padding:0.28rem 0.8rem; border-radius:20px;
            font-size:0.75rem; font-weight:600; font-family:inherit;
            border:1.5px solid transparent; background:transparent; color:var(--muted);
            cursor:pointer; transition:all .18s;
        }
        .filter-btn:hover { color:var(--text); }
        .filter-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
        .divider { width:1px; height:20px; background:var(--border); flex-shrink:0; }
        .clear-btn {
            padding:0.28rem 0.8rem; border-radius:20px;
            font-size:0.75rem; font-weight:600; font-family:inherit;
            border:1.5px solid transparent; background:transparent; color:var(--danger);
            cursor:pointer; transition:all .18s; white-space:nowrap;
        }
        .clear-btn:hover:not(:disabled) { background:var(--danger); color:#fff; border-color:var(--danger); }
        .clear-btn:disabled { color:var(--border); cursor:not-allowed; }

        /* Confirm banner (shared for clear + delete) */
        .confirm-banner {
            display:none; align-items:center; justify-content:space-between;
            padding:0.7rem 1rem; background:#fef2f2; border:1px solid #fecaca;
            border-radius:12px; margin-bottom:1rem;
            font-size:0.82rem; color:#991b1b; gap:0.75rem;
            animation: fadeIn .2s ease-out;
        }
        .confirm-banner.visible { display:flex; }
        .confirm-banner strong { flex:1; }
        .confirm-actions { display:flex; gap:0.4rem; }
        .confirm-yes {
            padding:0.25rem 0.75rem; border-radius:8px; background:var(--danger); color:#fff;
            border:none; font-size:0.78rem; font-weight:600; font-family:inherit; cursor:pointer;
        }
        .confirm-yes:hover { background:#dc2626; }
        .confirm-no {
            padding:0.25rem 0.75rem; border-radius:8px; background:transparent; color:var(--muted);
            border:1px solid var(--border); font-size:0.78rem; font-weight:600;
            font-family:inherit; cursor:pointer;
        }
        .confirm-no:hover { background:var(--bg); }

        /* Date groups */
        .date-group { margin-bottom:1.75rem; }
        .date-label { display:flex; align-items:center; gap:0.75rem; margin-bottom:0.6rem; }
        .date-label span { font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:.09em; color:var(--muted); white-space:nowrap; }
        .date-label-line { flex:1; height:1px; background:var(--border); }
        .task-list { list-style:none; display:flex; flex-direction:column; gap:0.4rem; }

        /* Task item */
        .task-item {
            display:flex; align-items:flex-start; gap:0.75rem;
            padding:0.8rem 1rem; background:var(--bg); border-radius:12px;
            border:1px solid var(--border); transition:all .22s; animation:slideIn .28s ease-out;
        }
        @keyframes slideIn {
            from { opacity:0; transform:translateX(-8px); }
            to   { opacity:1; transform:translateX(0); }
        }
        .task-item:not(.completed):hover { background:#fff; border-color:var(--accent); }
        .task-item.completed { opacity:.5; }

        /* Checkbox */
        .task-checkbox {
            width:20px; height:20px; flex-shrink:0; margin-top:2px;
            appearance:none; -webkit-appearance:none;
            border:2px solid var(--border); border-radius:6px;
            background:#fff; cursor:pointer; transition:all .18s; position:relative;
        }
        .task-checkbox:hover { border-color:var(--success); }
        .task-checkbox:checked { background:var(--success); border-color:var(--success); }
        .task-checkbox:checked::after {
            content:''; position:absolute; top:3px; left:6px;
            width:5px; height:9px;
            border:2px solid #fff; border-top:none; border-left:none;
            transform:rotate(45deg);
        }

        .task-body { flex:1; min-width:0; }
        /* Allow wrapping so full text is always visible */
        .task-text {
            display:block; font-size:0.93rem; transition:all .2s;
            cursor:default; word-break:break-word; white-space:normal;
            line-height:1.45;
        }
        .task-item.completed .task-text { text-decoration:line-through; color:var(--done); }
        .task-meta { display:flex; align-items:center; gap:0.45rem; margin-top:0.22rem; flex-wrap:wrap; }
        .stamp { font-size:0.68rem; color:var(--muted); font-variant-numeric:tabular-nums; }
        .edited-badge {
            font-size:0.65rem; color:var(--warn); font-weight:600;
            background:#fef3c7; padding:0.1rem 0.4rem; border-radius:4px;
        }
        .task-time {
            background:var(--accent); color:#fff;
            padding:0.1rem 0.5rem; border-radius:5px;
            font-size:0.67rem; font-weight:700; white-space:nowrap;
        }
        .task-item.completed .task-time { background:var(--done); }

        .task-actions { display:flex; gap:0.25rem; flex-shrink:0; margin-top:1px; }
        .edit-btn {
            width:28px; height:28px; display:flex; align-items:center; justify-content:center;
            background:transparent; border:none; color:var(--muted);
            cursor:pointer; border-radius:7px; transition:all .2s; font-size:0.85rem;
        }
        .edit-btn:hover { background:#fef3c7; color:#d97706; }
        .delete-btn {
            width:28px; height:28px; display:flex; align-items:center; justify-content:center;
            background:transparent; border:none; color:var(--muted);
            cursor:pointer; border-radius:7px; transition:all .2s; font-size:1.1rem; font-weight:700;
        }
        .delete-btn:hover { background:var(--danger); color:#fff; transform:rotate(90deg); }

        /* Empty state */
        .empty-state { text-align:center; padding:3rem 1rem; color:var(--muted); font-size:0.92rem; animation:fadeIn .4s ease-out; }
        .empty-icon { font-size:2.25rem; margin-bottom:0.6rem; opacity:.22; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        @media(max-width:500px) {
            .card { padding:2rem 1.375rem; }
            h1 { font-size:1.9rem; }
            .input-row { flex-wrap:wrap; }
            .add-btn { flex:1; }
            .live-clock { font-size:0.7rem; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="card">

        <div class="header">
            <div>
                <h1>Tasks</h1>
                <p class="subtitle">Organize your day, one task at a time</p>
                <div class="task-counter" id="taskCounter"></div>
            </div>
            <div class="live-clock" id="liveClock">‚Äî</div>
        </div>

        <div class="input-area">
            <div class="input-row">
                <input type="text" id="taskInput" placeholder="What needs to be done?" autocomplete="off">
                <button class="add-btn" id="addBtn">Add</button>
            </div>

            <!-- Schedule toggle ‚Äî hidden by default, shown on demand -->
            <div class="schedule-toggle-row">
                <button class="schedule-toggle-btn" id="scheduleToggleBtn">üìÖ Add a time</button>
                <span class="edit-hint" id="editHint">‚úèÔ∏è Editing task</span>
                <button class="cancel-edit-btn" id="cancelEditBtn">Cancel</button>
            </div>
            <div class="schedule-row" id="scheduleRow">
                <span class="schedule-label">Schedule (optional):</span>
                <input type="time" id="timeInput" class="time-input">
            </div>
        </div>

        <div class="toolbar">
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="active">Active</button>
                <button class="filter-btn" data-filter="done">Done</button>
            </div>
            <div class="divider"></div>
            <button class="clear-btn" id="clearDoneBtn" disabled>Clear completed</button>
        </div>

        <!-- Single shared confirm banner -->
        <div class="confirm-banner" id="confirmBanner">
            <strong id="confirmMsg">Are you sure?</strong>
            <div class="confirm-actions">
                <button class="confirm-yes" id="confirmYes">Yes, delete</button>
                <button class="confirm-no" id="confirmNo">Cancel</button>
            </div>
        </div>

        <div id="taskContainer"></div>
    </div>
</div>

<script>
    const taskInput        = document.getElementById('taskInput');
    const timeInput        = document.getElementById('timeInput');
    const addBtn           = document.getElementById('addBtn');
    const taskContainer    = document.getElementById('taskContainer');
    const liveClock        = document.getElementById('liveClock');
    const clearDoneBtn     = document.getElementById('clearDoneBtn');
    const confirmBanner    = document.getElementById('confirmBanner');
    const confirmMsg       = document.getElementById('confirmMsg');
    const confirmYes       = document.getElementById('confirmYes');
    const confirmNo        = document.getElementById('confirmNo');
    const filterBtns       = document.querySelectorAll('.filter-btn');
    const taskCounter      = document.getElementById('taskCounter');
    const editHint         = document.getElementById('editHint');
    const cancelEditBtn    = document.getElementById('cancelEditBtn');
    const scheduleToggleBtn = document.getElementById('scheduleToggleBtn');
    const scheduleRow      = document.getElementById('scheduleRow');

    let tasks          = JSON.parse(localStorage.getItem('tasks')) || [];
    let filter         = 'all';
    let editingIdx     = null;
    let confirmAction  = null; // stores the function to run on confirm
    let scheduleOpen   = false;

    // ‚îÄ‚îÄ Drift-free clock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function updateClock() {
        const now = new Date();
        liveClock.textContent = now.toLocaleString('en-US', {
            weekday:'short', month:'short', day:'numeric',
            hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true
        });
        setTimeout(updateClock, 1000 - now.getMilliseconds());
    }
    updateClock();

    // ‚îÄ‚îÄ Schedule toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    scheduleToggleBtn.addEventListener('click', () => {
        scheduleOpen = !scheduleOpen;
        scheduleRow.classList.toggle('visible', scheduleOpen);
        scheduleToggleBtn.classList.toggle('active', scheduleOpen);
        scheduleToggleBtn.textContent = scheduleOpen ? 'üìÖ Remove time' : 'üìÖ Add a time';
        if (scheduleOpen) timeInput.focus();
        else { timeInput.value = ''; }
    });

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function dateKey(ts) { return new Date(ts).toLocaleDateString('en-CA'); }

    function groupLabel(key) {
        const today     = dateKey(Date.now());
        const yesterday = dateKey(Date.now() - 86400000);
        if (key === today)     return 'Today';
        if (key === yesterday) return 'Yesterday';
        return new Date(key + 'T00:00:00').toLocaleDateString('en-US', {
            weekday:'long', month:'long', day:'numeric', year:'numeric'
        });
    }

    function formatStamp(ts) {
        const d = new Date(ts);
        const key = dateKey(ts);
        const today = dateKey(Date.now());
        const yesterday = dateKey(Date.now() - 86400000);
        const timeStr = d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true });
        if (key === today)     return timeStr;
        if (key === yesterday) return `Yesterday ${timeStr}`;
        return d.toLocaleDateString('en-US', { month:'short', day:'numeric' }) + ' ' + timeStr;
    }

    function formatScheduled(t) {
        if (!t) return '';
        const [h, m] = t.split(':');
        const hr = parseInt(h);
        return `${(hr % 12) || 12}:${m} ${hr >= 12 ? 'PM' : 'AM'}`;
    }

    function escapeHtml(str) {
        const d = document.createElement('div');
        d.textContent = str;
        return d.innerHTML;
    }

    function syncUI() {
        const active    = tasks.filter(t => !t.completed).length;
        const completed = tasks.filter(t =>  t.completed).length;
        taskCounter.innerHTML = tasks.length === 0 ? '' :
            `${active} task${active !== 1 ? 's' : ''} remaining <span>¬∑ ${completed} done</span>`;
        clearDoneBtn.disabled = completed === 0;
    }

    // ‚îÄ‚îÄ Shared confirm banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showConfirm(message, yesLabel, action) {
        // Cancel any open edit first ‚Äî confirm and edit cannot coexist
        cancelEdit();
        confirmMsg.textContent = message;
        confirmYes.textContent = yesLabel;
        confirmAction = action;
        confirmBanner.classList.add('visible');
    }

    function dismissConfirm() {
        confirmBanner.classList.remove('visible');
        confirmAction = null;
    }

    confirmYes.addEventListener('click', () => {
        if (confirmAction) confirmAction();
        dismissConfirm();
    });
    confirmNo.addEventListener('click', dismissConfirm);

    // ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderTasks() {
        taskContainer.innerHTML = '';
        syncUI();

        const visible = tasks.filter(t =>
            filter === 'all'    ? true :
            filter === 'active' ? !t.completed :
                                   t.completed
        );

        if (visible.length === 0) {
            let msg = 'No tasks yet! Add one above.', icon = '‚úì';
            if (filter === 'done') { msg = 'No completed tasks yet.'; icon = '‚óã'; }
            else if (filter === 'active' && tasks.length > 0) { msg = 'All tasks completed! üéâ'; icon = 'üéâ'; }
            taskContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">${icon}</div>
                    <p>${msg}</p>
                </div>`;
            return;
        }

        const groups = {};
        visible.forEach(task => {
            const k = dateKey(task.createdAt);
            if (!groups[k]) groups[k] = [];
            groups[k].push(task);
        });

        Object.keys(groups).sort((a,b) => b.localeCompare(a)).forEach(key => {
            const wrap = document.createElement('div');
            wrap.className = 'date-group';
            wrap.innerHTML = `
                <div class="date-label">
                    <span>${groupLabel(key)}</span>
                    <div class="date-label-line"></div>
                </div>
                <ul class="task-list"></ul>`;

            const ul = wrap.querySelector('.task-list');

            const sorted = [...groups[key]].sort((a,b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                return b.createdAt - a.createdAt;
            });

            sorted.forEach(task => {
                const realIndex = tasks.indexOf(task);
                const li = document.createElement('li');
                li.className = 'task-item' + (task.completed ? ' completed' : '');

                const timeHTML    = task.scheduledTime
                    ? `<span class="task-time">üïê ${formatScheduled(task.scheduledTime)}</span>` : '';
                const editedHTML  = task.editedAt
                    ? `<span class="edited-badge">edited ${formatStamp(task.editedAt)}</span>` : '';
                const editBtnHTML = !task.completed
                    ? `<button class="edit-btn" title="Edit task">‚úèÔ∏è</button>` : '';

                li.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                    <div class="task-body">
                        <span class="task-text">${escapeHtml(task.text)}</span>
                        <div class="task-meta">
                            <span class="stamp">Saved ${formatStamp(task.createdAt)}</span>
                            ${editedHTML}
                            ${timeHTML}
                        </div>
                    </div>
                    <div class="task-actions">
                        ${editBtnHTML}
                        <button class="delete-btn" title="Delete">√ó</button>
                    </div>`;

                li.querySelector('.task-checkbox').addEventListener('change', () => {
                    if (editingIdx === realIndex) cancelEdit();
                    dismissConfirm();
                    toggleTask(realIndex);
                });

                if (!task.completed) {
                    li.querySelector('.edit-btn').addEventListener('click', e => {
                        e.stopPropagation();
                        dismissConfirm(); // close confirm if open before editing
                        startEdit(realIndex, task);
                    });
                }

                // Individual delete ‚Äî shows confirm banner
                li.querySelector('.delete-btn').addEventListener('click', e => {
                    e.stopPropagation();
                    showConfirm(
                        `Delete "${task.text.length > 40 ? task.text.slice(0,40)+'‚Ä¶' : task.text}"?`,
                        'Yes, delete',
                        () => deleteTask(realIndex)
                    );
                });

                ul.appendChild(li);
            });

            taskContainer.appendChild(wrap);
        });
    }

    // ‚îÄ‚îÄ Edit mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function startEdit(i, task) {
        editingIdx = i;
        taskInput.value = task.text;

        // Show schedule row if task has a time, otherwise leave collapsed
        if (task.scheduledTime) {
            scheduleOpen = true;
            scheduleRow.classList.add('visible');
            scheduleToggleBtn.classList.add('active');
            scheduleToggleBtn.textContent = 'üìÖ Remove time';
            timeInput.value = task.scheduledTime;
        }

        taskInput.classList.add('editing');
        addBtn.textContent = 'Save';
        addBtn.classList.add('editing-mode');
        editHint.classList.add('visible');
        cancelEditBtn.classList.add('visible');
        taskInput.focus();
        taskInput.select();
    }

    function cancelEdit() {
        if (editingIdx === null) return;
        editingIdx = null;
        taskInput.value = '';
        timeInput.value = '';
        taskInput.classList.remove('editing');
        addBtn.textContent = 'Add';
        addBtn.classList.remove('editing-mode');
        editHint.classList.remove('visible');
        cancelEditBtn.classList.remove('visible');
        // Collapse schedule row on cancel
        scheduleOpen = false;
        scheduleRow.classList.remove('visible');
        scheduleToggleBtn.classList.remove('active');
        scheduleToggleBtn.textContent = 'üìÖ Add a time';
    }

    // ‚îÄ‚îÄ CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function addTask() {
        const text = taskInput.value.trim();
        if (!text) { taskInput.focus(); return; }

        if (editingIdx !== null) {
            tasks[editingIdx].text          = text;
            tasks[editingIdx].scheduledTime = (scheduleOpen && timeInput.value) ? timeInput.value : null;
            tasks[editingIdx].completed     = false;
            tasks[editingIdx].editedAt      = Date.now();
            cancelEdit();
            save(); renderTasks();
            return;
        }

        tasks.push({
            text,
            scheduledTime: (scheduleOpen && timeInput.value) ? timeInput.value : null,
            completed: false,
            createdAt: Date.now(),
            editedAt: null
        });

        save(); renderTasks();

        taskInput.classList.add('flash-success');
        addBtn.classList.add('pulse');
        setTimeout(() => taskInput.classList.remove('flash-success'), 600);
        setTimeout(() => addBtn.classList.remove('pulse'), 400);

        taskInput.value = '';
        timeInput.value = '';
        // Collapse schedule row after adding
        scheduleOpen = false;
        scheduleRow.classList.remove('visible');
        scheduleToggleBtn.classList.remove('active');
        scheduleToggleBtn.textContent = 'üìÖ Add a time';
        taskInput.focus();
    }

    function toggleTask(i) { tasks[i].completed = !tasks[i].completed; save(); renderTasks(); }

    function deleteTask(i) {
        if (editingIdx === i) cancelEdit();
        tasks.splice(i, 1);
        save(); renderTasks();
    }

    function clearCompleted() {
        tasks = tasks.filter(t => !t.completed);
        save(); renderTasks();
    }

    function save() { localStorage.setItem('tasks', JSON.stringify(tasks)); }

    // ‚îÄ‚îÄ Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    addBtn.addEventListener('click', addTask);
    taskInput.addEventListener('keypress', e => e.key === 'Enter' && addTask());
    taskInput.addEventListener('keydown',  e => { if (e.key === 'Escape') { cancelEdit(); dismissConfirm(); } });
    cancelEditBtn.addEventListener('click', cancelEdit);

    clearDoneBtn.addEventListener('click', () =>
        showConfirm('Delete all completed tasks? This can\'t be undone.', 'Yes, clear all', clearCompleted)
    );

    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            cancelEdit();
            dismissConfirm();
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filter = btn.dataset.filter;
            renderTasks();
        });
    });

    renderTasks();
</script>
</body>
</html>
